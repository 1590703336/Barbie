name: Deploy Preview to AWS EC2

on:
  push:
    branches:
      - preview

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy Preview to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/projects/Barbie-preview
            
            echo "ğŸ“¥ Fetching latest code..."
            git fetch origin preview
            
            echo "ğŸ”„ Resetting to latest commit..."
            git reset --hard origin/preview
            
            echo "ğŸ“¦ Installing backend dependencies..."
            cd apps/backend
            npm install --production
            
            echo "ï¿½ Configuring backend .env for preview..."
            # Update PORT from 4273 to 4274 (using regex)
            sed -i "s/^PORT=.*/PORT=4274/" .env.production.local
            # Update SERVER_URL to use port 4274 (using regex)
            sed -i "s|^SERVER_URL=.*|SERVER_URL=http://localhost:4274|" .env.production.local
            # Update FRONTEND_URL for preview path (using regex)
            sed -i "s|^FRONTEND_URL=.*|FRONTEND_URL=https://uofa.ink/preview|" .env.production.local
            
            echo "ï¿½ğŸ”„ Restarting preview backend..."
            pm2 restart barbie-backend-preview || pm2 start npm --name "barbie-backend-preview" -- start
            
            echo "ğŸ“ Configuring frontend for preview..."
            cd ../frontend
            
            # ä¿®æ”¹ vite.config.js: ç«¯å£æ”¹ä¸º 4274ï¼Œbase æ”¹ä¸º /preview/
            # Update backend port
            sed -i "s/const backendPort = .*;/const backendPort = mode === 'development' ? 5500 : 4274;/" vite.config.js
            # Comment out root base path
            sed -i "s|.*const base = '/';|  // const base = '/';|" vite.config.js
            # Uncomment preview base path
            sed -i "s|.*// const base = '/preview/';|  const base = '/preview/';|" vite.config.js
            
            echo "ğŸ“¦ Installing frontend dependencies..."
            npm install
            
            echo "ğŸ”¨ Building frontend..."
            npm run build
            
            echo "âœ… Preview deployment completed!"
            echo "ğŸŒ Access at: https://uofa.ink/preview/"
