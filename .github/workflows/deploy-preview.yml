name: Deploy Preview to AWS EC2

on:
  push:
    branches:
      - preview

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy Preview to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/projects/Barbie-preview
            
            echo "ğŸ“¥ Fetching latest code..."
            git fetch origin preview
            
            echo "ğŸ”„ Resetting to latest commit..."
            git reset --hard origin/preview
            
            echo "ğŸ“¦ Installing backend dependencies..."
            cd apps/backend
            npm install --production
            
            echo "ğŸ”„ Restarting preview backend..."
            pm2 restart barbie-backend-preview || pm2 start npm --name "barbie-backend-preview" -- start
            
            echo "ğŸ“ Configuring frontend for preview..."
            cd ../frontend
            
            # ä¿®æ”¹ vite.config.js: ç«¯å£æ”¹ä¸º 4274ï¼Œbase æ”¹ä¸º /preview/
            sed -i "s/const backendPort = mode === 'development' ? 5500 : 4273;/const backendPort = mode === 'development' ? 5500 : 4274;/" vite.config.js
            sed -i "s|const base = '/';|// const base = '/';|" vite.config.js
            sed -i "s|// const base = '/preview/';|const base = '/preview/';|" vite.config.js
            
            echo "ğŸ“¦ Installing frontend dependencies..."
            npm install
            
            echo "ğŸ”¨ Building frontend..."
            npm run build
            
            echo "âœ… Preview deployment completed!"
            echo "ğŸŒ Access at: https://uofa.ink/preview/"
